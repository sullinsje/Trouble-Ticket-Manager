@using Trouble_Ticket_Manager.Models.ViewModels
@model TicketViewModel

@{
    ViewData["Title"] = "Edit";
}

<h1>Edit</h1>

<h4>Ticket</h4>
<hr />
<div class="row">
    <div class="col-md-6">
        <form asp-controller="TicketAPI" asp-action="Edit" asp-route-id="@Model.Id" id="editForm" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="Id" />
            
            @* The List of selected tags must be passed to the controller, even if empty. *@
            @for (int i = 0; i < Model.SelectedAssetTags?.Count; i++)
            {
                <input type="hidden" name="SelectedAssetTags" value="@Model.SelectedAssetTags[i]" />
            }
            
            @* --------------------------------------------------------
            * NEW/EXISTING CONTACT TOGGLE
            * -------------------------------------------------------- *@
            <div class="form-group form-check">
                <label class="form-check-label">
                    <input type="checkbox" id="create-new-user-checkbox" class="form-check-input" />
                    Create New Contact?
                </label>
            </div>

            <div class="form-group" id="new-contact-name-group" style="display:none;">
                <p class="mt-2 text-info">Enter New Contact Details:</p>
                <div class="form-group">
                    <label asp-for="NewContactName" class="control-label">Contact Name</label>
                    <input asp-for="NewContactName" class="form-control" />
                    <span asp-validation-for="NewContactName" class="text-danger"></span>
                </div>
                @* ... other new contact fields (Email, Building, Room) are correct ... *@
                <div class="form-group">
                    <label asp-for="NewContactEmail" class="control-label">Contact Email</label>
                    <input asp-for="NewContactEmail" class="form-control" />
                    <span asp-validation-for="NewContactEmail" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="NewContactBuilding" class="control-label">Contact Building</label>
                    <input asp-for="NewContactBuilding" class="form-control" />
                    <span asp-validation-for="NewContactBuilding" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="NewContactRoom" class="control-label">Contact Room</label>
                    <input asp-for="NewContactRoom" class="form-control" />
                    <span asp-validation-for="NewContactRoom" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group" id="existing-contact-group">
                <label asp-for="SelectedContactId" class="control-label">Contact</label>
                @* The SelectedContactId value will pre-select the correct option once the JS populates the dropdown *@
                <select asp-for="SelectedContactId" class="form-control" id="contact-name-dropdown">
                    <option value="0">-- Loading Contacts --</option>
                </select>
                <span asp-validation-for="SelectedContactId" class="text-danger"></span>
            </div>
            
            <hr />
            
            <div class="form-group form-check">
                <label class="form-check-label">
                    <input type="checkbox" id="create-new-computer-checkbox" class="form-check-input" />
                    Create New Computer?
                </label>
            </div>

            <div id="new-computer-details-group" style="display:none;">
                <p class="mt-2 text-info">Enter New Computer Details:</p>
                <div class="form-group">
                    <label asp-for="NewAssetTag" class="control-label">Asset Tag</label>
                    <input asp-for="NewAssetTag" class="form-control" />
                    <span asp-validation-for="NewAssetTag" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="NewComputerServiceTag" class="control-label">Service Tag</label>
                    <input asp-for="NewComputerServiceTag" class="form-control" />
                    <span asp-validation-for="NewComputerServiceTag" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="NewComputerModel" class="control-label">Model</label>
                    <input asp-for="NewComputerModel" class="form-control" />
                    <span asp-validation-for="NewComputerModel" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group" id="existing-computer-group">
                <label class="control-label">Select Existing Computers</label>
                
                @* ðŸ’¡ CRITICAL CHANGE: Replaced the <select> with the checkbox container div *@
                <div id="asset-tag-checkbox-list" class="border p-3" style="max-height: 200px; overflow-y: auto;">
                    <p class="text-muted mb-0">Loading available computers...</p>
                </div>
                
                @* The validation summary needs to match the new list property name *@
                <span asp-validation-for="SelectedAssetTags" class="text-danger"></span>
            </div>
            
            <hr />

            @* --------------------------------------------------------
            * TICKET DETAILS
            * -------------------------------------------------------- *@
            <div class="form-group">
                <label asp-for="SubmittedAt" class="control-label">Submission Date</label>
                <input asp-for="SubmittedAt" class="form-control" />
                <span asp-validation-for="SubmittedAt" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="IssueDescription" class="control-label">Issue Description</label>
                <input asp-for="IssueDescription" class="form-control" />
                <span asp-validation-for="IssueDescription" class="text-danger"></span>
            </div>
            <div class="form-group form-check">
                <label class="form-check-label">
                    <input asp-for="IsResolved" class="form-check-input" /> @Html.DisplayNameFor(model => model.IsResolved)
                </label>
            </div>
            <div class="form-group form-check">
                <label class="form-check-label">
                    <input asp-for="ChargerGiven" class="form-check-input" /> @Html.DisplayNameFor(model => model.ChargerGiven)
                </label>
            </div>
            <div class="form-group mt-3">
                <input type="submit" value="Save Changes" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script type="module" src="~/js/ticketEdit.js"></script>
}